[% USE raw %]
[% USE Asset %]
[% USE Koha %]
[% USE KohaDates %]
[% USE TablesSettings %]
[% USE Price %]
[% PROCESS 'i18n.inc' %]
[% SET footerjs = 1 %]
[% INCLUDE 'doc-head-open.inc' %]

[% SET ShowSummaryHoldings = Koha.Preference('SummaryHoldings') %]

<title
    >[% FILTER collapse %]
        [% IF ( invoiceclosedate ) %]
            [% IF ( invoice ) %]
                [% tx("Receipt summary for {vendor}, invoice {invoice_number}", { vendor = name, invoice_number = invoice }) | html %]
            [% ELSE %]
                [% tx("Receipt summary for {vendor}", { vendor = name }) | html %]
            [% END %]
        [% ELSE %]
            [% tx("Receive orders from {vendor}", { vendor = name }) | html %]
        [% END %]
        &rsaquo; [% t("Acquisitions") | html %] &rsaquo; [% t("Koha") | html %]
    [% END %]</title
>
[% INCLUDE 'doc-head-close.inc' %]
</head>

<body id="acq_parcel" class="acq">
[% WRAPPER 'header.inc' %]
    [% INCLUDE 'acquisitions-search.inc' %]
[% END %]

[% WRAPPER 'sub-header.inc' %]
    [% WRAPPER breadcrumbs %]
        [% WRAPPER breadcrumb_item %]
            <a href="/cgi-bin/koha/acqui/acqui-home.pl">Acquisitions</a>
        [% END %]
        [% IF invoiceclosedate %]
            [% WRAPPER breadcrumb_item bc_active= 1 %]
                [% IF ( invoice ) %]
                    <span>Receipt summary for <em>[% name | html %] [ [% invoice | html %] ]</em></span>
                [% ELSE %]
                    <span>Receipt summary for <em>[% name | html %]</em></span>
                [% END %]
            [% END %]
        [% ELSE %]
            [% WRAPPER breadcrumb_item %]
                <a href="/cgi-bin/koha/acquisition/vendors/[% booksellerid | uri %]">[% name | html %]</a>
            [% END %]
            [% WRAPPER breadcrumb_item bc_active= 1 %]
                <span>Receive orders from [% name | html %]</span>
            [% END %]
        [% END %]
    [% END #/ WRAPPER breadcrumbs %]
[% END #/ WRAPPER sub-header.inc %]

[% WRAPPER 'main-container.inc' aside='acquisitions-menu' %]

    [% IF ( receive_error ) %]
        <div class="alert alert-warning">
            <h3>Error adding items:</h3>
            <ul>
                [% FOREACH error_loo IN error_loop %]
                    <li
                        >[% error_loo.error_param | html %][% IF ( error_loo.error_duplicate_barcode ) %]Duplicate barcode[% END %]
                        <!-- todo: other error conditions come here. --></li
                    >
                [% END %]
            </ul>
        </div>
    [% END %]
    <h1>
        [% IF ( invoiceclosedate ) %]
            <span>Receipt summary for <em>[% name | html %]</em></span> [% IF ( invoice ) %]<em> [ [% invoice | html %] ] </em>[% END %]
        [% ELSE %]
            <span>Receive orders from [% name | html %]</span>
        [% END %]
    </h1>

    [% IF ( success_delorder ) %]
        <div class="alert alert-info">The order has been successfully canceled.</div>
    [% ELSE %]
        [% IF ( error_delitem ) %]
            <div class="alert alert-warning">The order has been canceled, although one or more items could not have been deleted.</div>
        [% END %]
        [% IF ( error_delbiblio ) %]
            <div class="alert alert-warning">The order has been canceled, although the record has not been deleted.</div>
        [% END %]
    [% END %]

    [% IF (error_cancelling_receipt) %]
        <div class="alert alert-warning">
            <span>Cannot cancel receipt. Possible reasons:</span>
            <ul>
                <li> The order line you are trying to cancel was created from a partial receipt of another order line which is already received. Try to cancel this one first and retry. </li>
                <li> The order line you are trying to cancel was created from a partial receipt of another order line which has been deleted. Cancellation is not possible. </li>
            </ul>
        </div>
    [% END %]

    [% IF error_invoice_not_known %]
        <div class="alert alert-warning"> The invoice referenced by this invoiceid does not exist. </div>
    [% END %]

    [% UNLESS no_orders_to_display %]
        <div id="acqui_receive_summary">
            <p><strong>Invoice number:</strong> <a href="/cgi-bin/koha/acqui/invoice.pl?invoiceid=[% invoiceid | uri %]">[% invoice | html %]</a> <strong>Shipment date:</strong> [% shipmentdate | $KohaDates %]</p>
        </div>
        [% UNLESS (invoiceclosedate) %]
            <div id="acqui_receive_search" class="page-section">
                <h3>Pending orders</h3>
                <table id="pending_orders" class="table table-bordered table-striped">
                    <thead>
                        <tr>
                            <th></th>
                            <th>Basket</th>
                            <th>Basket group</th>
                            <th>Order line</th>
                            <th>Summary</th>
                            <th>View</th>
                            <th>Replacement price</th>
                            <th>Quantity</th>
                            <th>Unit cost</th>
                            <th>Order cost</th>
                            <th>Fund</th>
                            <th>&nbsp;</th>
                            <th>&nbsp;</th>
                        </tr>
                    </thead>
                </table>
                <fieldset class="action">
                    <button id="select_multiple" class="btn btn-primary"></button>
                </fieldset>
            </div>
        [% ELSE %]
            <p>
                <span>Invoice is closed, so you can't receive orders anymore.</span>
                [% IF CAN_user_acquisition_reopen_closed_invoices %]
                    <a href="/cgi-bin/koha/acqui/invoice.pl?op=reopen&invoiceid=[% invoiceid | uri %]&referer=/cgi-bin/koha/acqui/parcel.pl%3Finvoiceid=[% invoiceid | uri %]">Reopen it</a>.
                [% END %]
            </p>
        [% END %]

        <div id="acqui_receive_receivelist" class="page-section">
            <h3>Already received</h3>

            [% IF ( loop_received ) %]
                <form action="/cgi-bin/koha/acqui/parcel.pl" method="get" name="orderform">
                    <table id="receivedt">
                        <thead>
                            <tr>
                                <th>Basket</th>
                                <th>Basket group</th>
                                <th>Order line</th>
                                <th title="Item holds / Total holds">Holds</th>
                                <th>Summary</th>
                                <th class="no-sort">[% tp("Table column with more options", "More") | html %]</th>
                                <th>Replacement price</th>
                                <th>Quantity</th>
                                <th>Fund</th>
                                <th>Est cost</th>
                                <th>Actual cost</th>
                                <th>TOTAL</th>
                                <th class="no-sort"></th>
                            </tr>
                        </thead>
                        <tfoot>
                            [% FOREACH key IN subtotal_for_funds.keys.sort %]
                                <tr>
                                    [% IF invoiceincgst %]
                                        <td colspan="6" class="total">(Tax inc.)</td>
                                    [% ELSE %]
                                        <td colspan="6" class="total">(Tax exc.)</td>
                                    [% END %]
                                    <td colspan="3"><em>Subtotal for</em> [% key | html %]</td>
                                    <td>[% subtotal_for_funds.$key.ecost | $Price %]</td>
                                    <td>[% subtotal_for_funds.$key.unitprice | $Price %]</td>
                                    <td>&nbsp;</td>
                                    <td>&nbsp;</td>
                                </tr>
                            [% END %]
                            <tr>
                                <th colspan="11" class="total">Total tax exc.</th>
                                <th>[% total_tax_excluded | $Price %]</th>
                                <th></th>
                            </tr>
                            [% FOREACH book_foot IN book_foot_loop %]
                                <tr>
                                    <th colspan="11">Total (GST [% book_foot.tax_rate * 100 | html %]%)</th>
                                    <th>[% book_foot.tax_value | $Price %]</th>
                                    <th></th>
                                </tr>
                            [% END %]
                            <tr>
                                <th colspan="11" class="total">Total tax inc.</th>
                                <th>[% total_tax_included | $Price %]</th>
                                <th></th>
                            </tr>
                        </tfoot>
                        <tbody class="filterclass">
                            [% FOREACH order IN loop_received %]
                                <tr>
                                    <td><a href="/cgi-bin/koha/acqui/basket.pl?basketno=[% order.basketno | uri %]"> [% order.basketname | html %] ([% order.basketno | html %])</a></td>
                                    <td>
                                        [% IF order.basketgroupid %]
                                            <a href="/cgi-bin/koha/acqui/basketgroup.pl?op=add&amp;booksellerid=[% booksellerid | uri %]">[% order.basketgroupname | html %] ([% order.basketgroupid | html %])</a>
                                        [% ELSE %]
                                            No basket group
                                        [% END %]
                                    </td>
                                    <td>
                                        <a href="neworderempty.pl?ordernumber=[% order.ordernumber | uri %]&amp;booksellerid=[% booksellerid | uri %]">[% order.ordernumber | html %]</a>
                                        [% IF (order.parent_ordernumber && (order.parent_ordernumber != order.ordernumber)) %]
                                            (<a href="neworderempty.pl?ordernumber=[% order.parent_ordernumber | uri %]&amp;booksellerid=[% booksellerid | uri %]" title="Original order line">[% order.parent_ordernumber | html %]</a>)
                                        [% END %]
                                    </td>
                                    <td>
                                        [% IF order.total_holds > 0 %]
                                            [% IF order.item_holds > 0 %]
                                                <span class="error"><a href="/cgi-bin/koha/reserve/request.pl?biblionumber=[% order.biblionumber | uri %]">[% order.item_holds | html %]</a></span>
                                            [% ELSE %]
                                                0
                                            [% END %]
                                            /
                                            <span class="error"><a href="/cgi-bin/koha/reserve/request.pl?biblionumber=[% order.biblionumber | uri %]">[% order.total_holds | html %]</a></span>
                                        [% ELSE %]
                                            0
                                        [% END %]
                                    </td>
                                    <td>
                                        [% INCLUDE 'biblio-title.inc' biblio=order link = 1 %]
                                        [% IF ( order.author ) %]/ [% order.author | html %][% END %]
                                        [% IF ( order.isbn ) %]- [% order.isbn | html %][% END %]
                                        [% IF ( order.issn ) %] - [% order.issn | html %][% END %]
                                        [% IF ( order.publishercode ) %]
                                            <br />Publisher: [% order.publishercode | html %]
                                            [%- IF    ( order.publicationyear > 0) -%]
                                                , [% order.publicationyear | html %]
                                            [%- ELSIF ( order.copyrightdate   > 0) -%]
                                                [% order.copyrightdate | html %]
                                            [% END %]
                                        [% END %]
                                        [% IF ( order.suggestionid ) %]
                                            <br />
                                            Suggested by: [% order.surnamesuggestedby | html %][% IF ( order.firstnamesuggestedby ) %],Â [% order.firstnamesuggestedby | html %][% END %] (<a
                                                href="/cgi-bin/koha/suggestion/suggestion.pl?suggestionid=[% order.suggestionid | uri %]&amp;op=show"
                                                >suggestion #[% order.suggestionid | html %]</a
                                            >)
                                        [% END %]
                                        <br />

                                        <br />
                                        [% IF ( ShowSummaryHoldings ) %]
                                            [% SET holdings = order.biblio.holdings %]
                                            [% IF holdings %]
                                                <strong>Holdings: [% holdings.count() %]</strong>
                                                <ul>
                                                    [% FOREACH holding IN holdings %]
                                                        <li
                                                            ><a class="previewData" href="/cgi-bin/koha/catalogue/showmarc.pl?holding_id=[% holding.holding_id | html %]">
                                                                [% IF holding.callnumber %]
                                                                    [% holding.callnumber | html %]
                                                                [% ELSE %]
                                                                    ? [% holding.holding_id | html %]
                                                                [% END %]
                                                            </a>
                                                            [%
                                                                INCLUDE 'copy-to-clipboard-button.inc'
                                                                value = holding.callnumber
                                                                label = ''
                                                                class = 'btn btn-xs btn-light'
                                                            %]
                                                        </li>
                                                    [% END %]
                                                </ul>
                                            [% END %]
                                        [% END # /IF ShowSummaryHoldings %]

                                        [% IF ( order.order_internalnote ) %]
                                            <p class="ordernote"
                                                ><strong>Internal note: </strong>[% order.order_internalnote | html %] [<a
                                                    href="/cgi-bin/koha/acqui/modordernotes.pl?ordernumber=[% order.ordernumber | uri %]&amp;referrer=/cgi-bin/koha/acqui/parcel.pl%3Finvoiceid=[% invoiceid | uri %]&type=internal"
                                                    >Change internal note</a
                                                >]</p
                                            >
                                        [% ELSE %]
                                            [<a href="/cgi-bin/koha/acqui/modordernotes.pl?ordernumber=[% order.ordernumber | uri %]&amp;referrer=/cgi-bin/koha/acqui/parcel.pl%3Finvoiceid=[% invoiceid | uri %]&type=internal"
                                                >Add internal note</a
                                            >]
                                        [% END %]
                                        [% IF ( order.order_vendornote ) %]
                                            <p class="ordernote"><strong>Vendor note: </strong>[% order.order_vendornote | html %]</p>
                                        [% ELSE %]
                                            [<a href="/cgi-bin/koha/acqui/modordernotes.pl?ordernumber=[% order.ordernumber | uri %]&amp;referrer=/cgi-bin/koha/acqui/parcel.pl%3Finvoiceid=[% invoiceid | uri %]&type=vendor"
                                                >Add vendor note</a
                                            >]
                                        [% END %]
                                    </td>
                                    <td>
                                        <a href="/cgi-bin/koha/acqui/showorder.pl?ordernumber=[% order.ordernumber | uri %]" class="previewData">[% tp('noun', 'Order') | html %]</a><br />
                                        <a href="/cgi-bin/koha/catalogue/showmarc.pl?id=[% order.biblionumber | uri %]" class="previewData">MARC</a><br />
                                        <a href="/cgi-bin/koha/catalogue/showmarc.pl?viewas=card&amp;id=[% order.biblionumber | uri %]" class="previewData">Card</a>
                                    </td>
                                    <td>[% order.replacementprice | $Price %]</td>
                                    <td>[% order.quantityreceived | html %]</td>
                                    <td>[% order.budget.budget_name | html %]</td>
                                    <td>[% order.ecost | $Price %]</td>
                                    <td>[% order.unitprice | $Price %]</td>
                                    <td>[% order.total | $Price %]</td>
                                    <td>
                                        [% IF loop_receive.cannot_cancel or ( order.basket.effective_create_items == "receiving" and loop_receive.holds > 0 ) %]
                                            [% IF loop_receive.cannot_cancel %]
                                                [% span_title = BLOCK %]
                                                    <span
                                                        >Cannot cancel receipt of this order line because it was created from a partial receipt of order line no. [% order.parent_ordernumber | html %], which is already received. Try
                                                        cancelling this one first and retry.</span
                                                    >
                                                [% END %]
                                            [% ELSE %]
                                                [%# FIXME Here we block the cancellation if holds exist. Actually it could be possible if items will be exist after the deletion %]
                                                [%# Some additional checks should be added in the pl file %]
                                                [% span_title = BLOCK %]
                                                    <span>Cannot cancel receipt of this order line because at least one hold exists on the records.</span>
                                                [% END %]
                                            [% END %]
                                            <span title="[% span_title | collapse | html %]"> Can't cancel receipt </span>
                                        [% ELSE %]
                                            <a href="#" class="cancel_receipt" data-ordernumber="[% order.ordernumber | html %]">Cancel receipt</a>
                                        [% END %]
                                    </td>
                                </tr>
                            [% END %]
                        </tbody>
                    </table>
                </form>
                <form id="cancel_receipt" method="post" action="/cgi-bin/koha/acqui/parcel.pl">
                    [% INCLUDE 'csrf-token.inc' %]
                    <input type="hidden" name="op" value="cud-cancelreceipt" />
                    <input type="hidden" name="ordernumber" id="cancel_ordernumber" value="" />
                    <input type="hidden" name="invoiceid" value="[% invoiceid | html %]" />
                </form>
            [% ELSE %]
                There are no received orders.
            [% END %]
        </div>

        <div class="modal" id="dataPreview" tabindex="-1" role="dialog" aria-labelledby="dataPreviewLabel">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title" id="dataPreviewLabel">MARC previews</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="loading"> <img src="[% interface | html %]/[% theme | html %]/img/spinner-small.gif" alt="" /> Loading </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-default" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
                <!-- /.modal-content -->
            </div>
            <!-- /.modal-dialog -->
        </div>
        <!-- /.modal -->

        [% IF (invoiceclosedate) %]
            <a href="/cgi-bin/koha/acqui/invoice.pl?invoiceid=[% invoiceid | uri %]">View invoice</a>
        [% ELSE %]
            <form action="/cgi-bin/koha/acqui/invoice.pl" method="get">
                <input type="hidden" name="invoiceid" value="[% invoiceid | html %]" />
                <fieldset class="action">
                    <input type="submit" class="btn btn-primary" value="Finish receiving" />
                </fieldset>
            </form>
        [% END %]
    [% END %]
[% END %]

[% MACRO jsinclude BLOCK %]
    [% Asset.js("js/acquisitions-menu.js") | $raw %]
    [% Asset.js("js/copyToClipboard.js") | $raw %]
    [% INCLUDE 'datatables.inc' %]
    <style>
        fieldset.action {
            margin-bottom: 20px;
        }
    </style>
    <script>
        dt_overwrite_html_sorting_localeCompare();
        var PENDING_MULTI_SELECTION = _("Receive selected (%s)");
        var columns_filter = {};

        $(document).ready(function(){

            $(".cancel_receipt").on( 'click', function(e){
                e.preventDefault();
                $('#cancel_ordernumber').val( $(this).data('ordernumber') );
                $('#cancel_receipt').submit();
            });

            if ( $("#receivedt").length ) {
                var receivedt = $("#receivedt").kohaTable({
                    stateSave: true, // We do not have table settings on this table
                    pageLength: 10,
                    lengthMenu: [
                        [5, 10, 20, 50, 100, -1],
                        [5, 10, 20, 50, 100, _("All")],
                    ],
                    columns: [
                        { type: "html" },
                        { type: "html" },
                        { type: "html" },
                        { type: "num-html" },
                        { type: "anti-the" },
                        null,
                        null,
                        null,
                        null,
                        null,
                        null,
                        null,
                        null,
                    ],
                    pagingType: "full",
                });

                $('#receivedt_wrapper .dataTables_filter input').off().on('keyup', function() {
                    // Draw the table to execute the search plugin
                    receivedt.DataTable().draw();
                });

            }

            var options = {
                "ajax": {
                    "url": '/api/v1/acquisitions/orders?only_active=1'
                },
                "embed": [
                    "basket.basket_group",
                    "biblio.uncancelled_orders+count",
                    "biblio.holds+count",
                    "biblio.items+count",
                    "biblio.suggestions.suggester",
                    "fund",
                    "current_item_level_holds+count",
                    "items",
                    "biblio.holdings"
                ],
                "columns": [
                    { "data": "basket.name",
                      "searchable": true,
                      "orderable": true,
                      "render": function(data, type, row, meta) {
                        if (type != 'display') return escape_str(data);
                        return "<a href=\"/cgi-bin/koha/acqui/basket.pl?basketno=" + encodeURIComponent(row.basket.basket_id) + "\">" + escape_str(data) + " (" + escape_str(row.basket.basket_id) + ")</a>";
                      }
                    },
                    { "data": "basket.basket_group.name",
                      "orderable": true,
                      "render": function(data, type, row, meta) {
                        if ( type != 'display' ) {
                            return escape_str(data);
                        }
                        if ( row.basket.basket_group_id == null ) {
                            return _("No basket group");
                        }
                        else {
                            return "<a href=\"/cgi-bin/koha/acqui/basketgroup.pl?op=add&amp;booksellerid="
                                    + encodeURIComponent(row.basket.vendor_id) + "&amp;basketgroupid="
                                    + encodeURIComponent(row.basket.basket_group_id) + "\">"
                                    + escape_str(row.basket.basket_group.name) + " (" + escape_str(row.basket.basket_group_id) + ")</a>";
                        }
                      }
                    },
                    {
                        "data": "order_id",
                        "render": function(data, type, row, meta) {
                            if (type != 'display') return escape_str(data);
                            return "<a href=\"neworderempty.pl?ordernumber="+encodeURIComponent(data)+"&amp;booksellerid="+encodeURIComponent(row.basket.vendor_id)+"\">"+escape_str(data)+"</a>";
                        }
                    },
                    {
                        [% SET summary_fields = "biblio.title:biblio.author:biblio.isbn:biblio.issn:biblio.publisher:me.internal_note:me.vendor_note" %]
                        [% IF Koha.Preference('marcflavour')=='UNIMARC' %][% SET summary_fields = summary_fields _ ":biblio.ean" %][% END %]
                        "data": "[% summary_fields | html %]",
                        "searchExpander": function(attr, value) {
                            let variations = [];

                            if ( !attr.match(/\.(isbn|issn)$/) ) {
                                return [];
                            }
                            if (value.match(/^\s*\d+[-\d+]*\s*$/)) {
                                value = value.replace(/\D/g, '');
                                variations.push(value);

                                // variations:
                                let templates = [
                                    'X-XX-XX-XXXX-X',
                                    'X-XX-XXX-XXX-X',
                                    'X-XX-XXXXX-X',
                                    'X-XX-XXXXXX-X',
                                    'X-XXX-XX-XXX-X',
                                    'X-XXX-XXXXX-X',
                                    'X-XXX-XXX-XX-X',
                                    'X-XXX-XXXX-X',
                                    'X-XXX-XXXXXX-X',
                                    'X-XXXX-XXX-X',
                                    'X-XXXX-XXXX-X',
                                    'X-XXXX-XXXXX',
                                    'X-XXXXX-XX-X',
                                    'X-XXXXX-XXXX-X',
                                    'X-XXXXX-XXX-X',
                                    'X-XXXXXX-XX-X',
                                    'X-XXXXXXX-X-X',
                                    'X-XXXXXXXX-X',
                                    'XX-X-XXXXXX-X',
                                    'XX-XX-XXXXX-X',
                                    'XX-XXX-XXXX-X',
                                    'XX-XXXX-XXX-X',
                                    'XX-XXXX-XXXX',
                                    'XX-XXXXX-XX-X',
                                    'XX-XXXXX-XXX',
                                    'XX-XXXXXX-X-X',
                                    'XX-XXXXXXX-X',
                                    'XXX-X-XX-XXXXXX-X',
                                    'XXX-X-XXX-XXXXXX',
                                    'XXX-X-XXX-XXXXX-X',
                                    'XXX-X-XXXX-XXXX-X',
                                    'XXX-X-XXXXX-XXX-X',
                                    'XXX-X-XXXXXX-XX-X',
                                    'XXX-X-XXXXXXX-X-X',
                                    'XXX-X-XXXXXXXX-XX',
                                    'XXX-XX-X-XXXXXX-X',
                                    'XXX-XX-XX-XXXXX-X',
                                    'XXX-XX-XXX-XXXX-X',
                                    'XXX-XX-XXXX-XXX-X',
                                    'XXX-XX-XXXXX-XX-X',
                                    'XXX-XX-XXXXXX-X-X',
                                    'XXX-XX-XXXXXXX-X',
                                    'XXX-XXX-X-XXXXX-X',
                                    'XXX-XXX-XX-XXXX-X',
                                    'XXX-XXX-XXX-XXX-X',
                                    'XXX-XXX-XXXX-XX-X',
                                    'XXX-XXX-XXXX-XXX',
                                    'XXX-XXX-XXXXX-X-X',
                                    'XXX-XXX-XXXXXX-X',
                                    'XXX-XXXX-X-XXXX-X',
                                    'XXX-XXXX-XX-XXX-X',
                                    'XXX-XXXX-XXX-XX-X',
                                    'XXX-XXXX-XXXX-X-X',
                                    'XXX-XXXX-XXXXX-X',
                                    'XXX-XXXXX-X-XXX-X',
                                    'XXX-XXXXX-XXXX-X',
                                    'XXX-XXXXXX-X-XX-X',
                                    'XXX-XXXXXX-XXX-X',
                                    'XXX-XXXXXXXXXX',
                                    'XXXX-X-XXXX-X',
                                    'XXXX-XX-XXX-X',
                                    'XXXX-XXX-XX-X',
                                    'XXXX-XXXX-X-X',
                                    'XXXX-XXXXX-X',
                                    'XXXXX-XX-XX-X'
                                ];

                                // loop over templates and replace X with digits,
                                // even if there's not enough digits to fill so cut on that point (incomplete):
                                for (let template of templates) {
                                    let variation = '';
                                    let i = 0;
                                    for (let c of template) {
                                        if (i >= value.length) {
                                            break;
                                        }
                                        if (c === 'X') {
                                            variation += value[i];
                                            i++;
                                        } else {
                                            variation += c;
                                        }
                                    }
                                    variations.push(variation);
                                }
                            }
                            return variations;
                        },
                        "render": function(data, type, row, meta) {
                            var result = '';
                            if ( row && row.biblio_id != null ) {
                                result = "<p><a href=\"/cgi-bin/koha/catalogue/detail.pl?biblionumber="+encodeURIComponent(row.biblio_id)+"\">"+escape_str(row.biblio.title)+"</a>";
                                if ( row.biblio.author != null )
                                    result += _(" by ") + escape_str(row.biblio.author);
                                if ( row.biblio.isbn != null )
                                    result += " &ndash; " + escape_str(row.biblio.isbn);
                                if ( row.biblio.issn != null )
                                    result += " &ndash; " + escape_str(row.biblio.issn);
                                [% IF Koha.Preference('marcflavour')=='UNIMARC' %]
                                    if ( row.biblio.ean != null )
                                        result += " &ndash; EAN:" + escape_str(row.biblio.ean);
                                [% END %]
                                if ( row.biblio.publisher != null ) {
                                    result += "<br/>" + _("Publisher: ") + escape_str(row.biblio.publisher);
                                    if ( row.biblio.publication_year != null ) {
                                        result += ", " + escape_str(row.biblio.publication_year);
                                    }
                                    else if ( row.biblio.copyright_date != null ) {
                                        result += escape_str(row.biblio.copyright_date);
                                    }
                                }
                                var suggestions = row.biblio.suggestions;
                                if ( suggestions != null && suggestions.length > 0 ) {
                                    var suggestion = suggestions[0];
                                    if ( suggestion.suggester != null ) {
                                        var suggester = suggestion.suggester;
                                        var suggested_by = [];
                                        if ( suggester.surname != null ) {
                                            suggested_by.push(escape_str(suggester.surname));
                                        }
                                        if ( suggester.firstname != null ) {
                                            suggested_by.push(escape_str(suggester.firstname));
                                        }

                                            result += "<br/>" + _("Suggested by: ") +
                                                        '<a href="/cgi-bin/koha/suggestion/suggestion.pl?suggestionid='
                                                            + encodeURIComponent(suggestion.suggestionid)
                                                            + '&amp;op=show">'
                                                            + suggested_by.join(", ")
                                                            + " (#" + escape_str(suggestions[0].suggestionid) + ")</a>"; // FIXME: could be changed if we allow matching multiple suggestions
                                    }
                                }
                                result += '</p>';

                                [% IF ( ShowSummaryHoldings ) %]
                                var holdings_records = row.biblio.holdings;
                                if ( holdings_records != null && holdings_records.length > 0 ) {
                                    result += "<strong>" + _("Holdings: ") + "</strong><ul>";
                                    for (var i = 0; i < holdings_records.length; i++) {
                                        var holdings_record = holdings_records[i];
                                        result += '<li>';
                                        result += '<a class="previewData" href="/cgi-bin/koha/catalogue/showmarc.pl?holding_id=' + encodeURIComponent(holdings_record.holding_id) + '">';
                                        let hr;
                                        if ( holdings_record.callnumber != null ) {
                                            hr = escape_str(holdings_record.callnumber);
                                        } else {
                                            hr = '? ' + escape_str(holdings_record.holding_id);
                                        }
                                        result += hr;
                                        result += '</a>';
                                        result += `<button onClick="copyValueToClipboard(this, '${hr}')" title="Copy to clipboard" class="btn btn-xs btn-light" data-bs-delay='{"show":0,"hide":2000}'><i class="fa-solid fa-clipboard"></i></button>`;
                                        result += '</li>';
                                    }
                                    result += '</ul>';
                                }
                                [% END # /IF ShowSummaryHoldings %]
                            }

                            var internal_note = row.internal_note;
                            if ( internal_note != null && internal_note != '' ) {
                                result += '<p class="ordernote"><strong>'
                                            + _("Internal note: ")
                                            + '</strong>' + escape_str(internal_note)
                                            + ' [<a href="/cgi-bin/koha/acqui/modordernotes.pl?ordernumber='
                                            + encodeURIComponent(row.order_id) + '&amp;referrer=/cgi-bin/koha/acqui/parcel.pl%3Finvoiceid=[% invoiceid | uri %]'
                                            + '&type=internal">' + _("Change internal note") + '</a>]</p>';
                            }
                            else {
                                result += ' [<a href="/cgi-bin/koha/acqui/modordernotes.pl?ordernumber='
                                            + encodeURIComponent(row.order_id) + '&amp;referrer=/cgi-bin/koha/acqui/parcel.pl%3Finvoiceid=[% invoiceid | uri %]'
                                            + '&type=internal">' + _("Add internal note") + '</a>]';
                            }

                            var vendor_note = row.vendor_note;
                            if ( vendor_note != null && vendor_note != '' ) {
                                result += '<p class="ordernote"><strong>'
                                            + _("Vendor note: ")
                                            + '</strong>' + escape_str(vendor_note) + '</p>';
                            }
                            else {
                                result += ' [<a href="/cgi-bin/koha/acqui/modordernotes.pl?ordernumber='
                                            + encodeURIComponent(row.order_id) + '&amp;referrer=/cgi-bin/koha/acqui/parcel.pl%3Finvoiceid=[% invoiceid | uri %]'
                                            + '&type=vendor">' + _("Add vendor note") + '</a>]';
                            }

                            return result;
                        },
                        "orderable": true,
                    },
                    {
                        "data": "",
                        "render": function(data, type, row, meta) {
                            var result = '<div class="btn-group dropup">';

                            result += '<button id="view' + row.order_id + '" type="button" class="btn btn-default btn-xs">' + _("View") + '</button>';
                            result += '<button type="button" class="btn btn-default btn-xs dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false"><span class="visually-hidden">Toggle dropdown</span></button>';

                            result += '<ul class="dropdown-menu" aria-labelledby="view' + row.order_id + '">';
                                result += '<li><a class="dropdown-item previewData" href="/cgi-bin/koha/acqui/showorder.pl?ordernumber=' + encodeURIComponent(row.order_id) + '">[% tp("noun", "Order") | html %]</a></li>';
                                result += '<li><a class="dropdown-item previewData" href="/cgi-bin/koha/catalogue/showmarc.pl?id=' + encodeURIComponent(row.biblio_id) + '">' + _("MARC") + '</a></li>';
                                result += '<li><a class="dropdown-item previewData" href="/cgi-bin/koha/catalogue/showmarc.pl?viewas=card&amp;id=' + encodeURIComponent(row.biblio_id) + '">' + _("Card") + '</a></li>';
                            result += '</ul>';
                            result += '</div>';
                            return result;
                        },
                        "orderable": false,
                        "searchable": false
                    },
                    {
                        "data": "replacement_price",
                        "render": function(data, type, row, meta) {
                            return escape_price(row.replacement_price);
                        },
                    },
                    {
                        "data": "quantity",
                        "orderable": true
                    },
                    {
                        "data": "ecost",
                        "render": function(data, type, row, meta) {
                            return escape_price(row.ecost);
                        },
                    },
                    {
                        "data": "",
                        "render": function(data, type, row, meta) {
                            return escape_price(row.quantity * row.ecost);
                        },
                        "orderable": false, // FIXME: How can we do it in DBIC?
                        "searchable": false
                    },
                    {
                        "data": "fund.name",
                        "render": function(data, type, row, meta) {
                            if (type != 'display') return escape_str(data);
                            return escape_str(row.fund.name);
                        }
                    },
                    {
                        "data": "",
                        "render": function(data, type, row, meta) {
                            return '<a href="orderreceive.pl?multiple_orders='
                                    + encodeURIComponent(row.order_id) + '&amp;invoiceid=[% invoiceid | uri %]' + '">'
                                    + _("Receive") + '</a><br/>'
                                    + '<a href="#" onclick="transfer_order_popup(' + escape_str(row.order_id) + '); return false;">'
                                    + _("Transfer") + '</a>';
                        },
                        "orderable": false,
                        "searchable": false
                    },
                    {
                        "data": "",
                        "render": function(data, type, row, meta) {
                            var result = "";

                            if ( row.current_holds_count > 0 ) {
                                result += '<span class="button" title="'
                                        + _("Can't cancel order, (%s) holds are linked with this order. Cancel holds first").format( escape_str(row.holds_count) ) + '">'
                                        + _("Can't cancel order") + '</span><br/>';
                            }
                            else {
                                result += '<a href="/cgi-bin/koha/acqui/cancelorder.pl?ordernumber='
                                            + encodeURIComponent(row.order_id)
                                            + '&biblionumber=' + encodeURIComponent(row.biblio_id)
                                            + '&referrer=/cgi-bin/koha/acqui/parcel.pl?invoiceid=[% invoiceid | uri %]">'
                                            + _("Cancel order") + '</a><br/>';
                            }

                            if ( row.biblio != null ) {
                                if ( row.biblio.items_count - row.items.length > 0 ||
                                    row.biblio.uncancelled_orders_count > 1 ||
                                    row.biblio.subscriptions_count > 0 ||
                                    row.biblio.holds_count > 0 ) { // biblio can be deleted
                                    result += '<span class="button" title="'
                                            + _("Can't delete catalog record, see constraints below") + '">'
                                            + _("Can't cancel order and delete catalog record") + '</span><br>';
                                }
                                else {
                                    result += '<a href="/cgi-bin/koha/acqui/cancelorder.pl?ordernumber='
                                            + encodeURIComponent(row.order_id) + '&biblionumber=' + encodeURIComponent(row.biblio_id)
                                            + '&del_biblio=1&referrer="/cgi-bin/koha/acqui/parcel.pl?invoiceid=[$ invoiceid | uri ]">'
                                            + _("Cancel order and catalog record") + '</a><br/>';
                                }

                                if ( row.biblio.items_count - row.items.length > 0 ) {
                                    result += '<strong title="'
                                            + _("Can't delete catalog record, because of %s existing item(s)").format(row.items.length)
                                            +'">' + (row.biblio.items_count - row.items.length) + _(" item(s) left") + '</strong><br/>';
                                }

                                if ( row.biblio.uncancelled_orders_count > 1 ) {
                                    result += '<strong title="'
                                            + _("Can't delete catalog record, delete other orders linked to it first") + '">'
                                            + (row.biblio.uncancelled_orders_count - 1) + _(" order(s) left") + '</strong><br/>';
                                }

                                if ( row.biblio.subscriptions_count > 0 ) {
                                    result += '<strong title="' + _("Can't delete catalog record, delete subscriptions first") + '">'
                                            + _("%s subscription(s) left").format(row.biblio.subscriptions_count)
                                            + '</strong><br>';
                                }

                                if ( row.biblio.holds_count > 0 ) {
                                    result += '<strong title="' + _("Can't delete catalog record or order, cancel holds first") + '">'
                                            + _("%s hold(s) left").format(row.biblio.holds_count) + '</strong>';
                                }
                            }

                            return result;
                        },
                        "orderable": false,
                        "searchable": false
                    }
                ]
            };

            var selected_rows = {};
            $('#select_multiple').click(function () {
                var ids = Object.keys(selected_rows);
                if (!ids.length) return;
                location.href = 'orderreceive.pl?multiple_orders=' + ids.join(',') + '&invoiceid=[% invoiceid | uri %]';
            }).html(PENDING_MULTI_SELECTION.format('0'))
            options.order = [[1, 'asc']];
            options.columns.unshift({
                "data": function (row, type, val, meta) {
                    return '<input type="checkbox" class="selOrder" />';
                },
                "searchable": false,
                "orderable": false
            });

            let table_settings = [% TablesSettings.GetTableSettings( 'acqui', 'parcel', 'pending_orders', 'json' ) | $raw %];

            var pending_orders_table = $("#pending_orders").kohaTable(options, table_settings, 1, { "basket.vendor_id": [% booksellerid | html %] });

            $.fn.dataTable.ext.search.push(
                function( settings, searchData, index, rowData, counter ) {
                    let term = $(settings.nTableWrapper).find('.dataTables_filter input').val();
                    if (term === '') {
                        return true;
                    }
                    var row = searchData.join(' ');
                    if (term.match(/^\s*\d+[-\d+]*\s*$/)) {
                        let new_term = term.replace(/-/g, '').trim();
                        row = row.replace(/\b\d[\d-]{7,}\d\b/g,
                            (match) => {
                                return match.replace(/-/g,'');
                            });
                        term=new_term;
                    }
                    if (row.match(new RegExp(term, 'i'))) {
                        return true;
                    }
                    return false;
                }
            );

            $('#pending_orders_wrapper .dataTables_filter input').off().on('keyup', function() {
                // Draw the table to execute the search plugin
                pending_orders_table.DataTable().draw();
            });

            var api = pending_orders_table.api();
            api.on('draw', function () {
                api.rows().every(function () {
                    var row = this;
                    var data = row.data();
                    $('.selOrder', row.node()).on('click', function (event) {
                        if ($(this).prop('checked')) {
                            selected_rows[data.order_id] = data;
                        } else {
                            delete selected_rows[data.order_id];
                        }
                        $('#select_multiple').html(PENDING_MULTI_SELECTION.format(Object.keys(selected_rows).length));
                    });
                    if (selected_rows[data.order_id]) {
                        $('.selOrder', row.node()).prop('checked', true);
                    }
                });
            });

            $("#dataPreview").on("hidden.bs.modal", function(){
                $("#dataPreviewLabel").html("");
                $("#dataPreview .modal-body").html("<div id=\"loading\"><img src=\"[% interface | html %]/[% theme | html %]/img/spinner-small.gif\" alt=\"\" /> "+_("Loading")+"</div>");
            });

            $("body").on("click", ".previewData", function(e){
                e.preventDefault();
                var ltitle = $(this).text();
                var page = $(this).attr("href");
                $("#dataPreviewLabel").text(ltitle);
                $("#dataPreview .modal-body").load(page + " div");
                $('#dataPreview').modal("show");
            });

        });

        // Case-insensitive version of jquery's contains function
        jQuery.extend(jQuery.expr[':'], {
            icontains : "jQuery(a).text().toUpperCase().indexOf(m[3].toUpperCase())>=0"
        });

        // Contains exactly function
        jQuery.extend(jQuery.expr[':'], {
            containsExactly: "$(a).text() == m[3]"
        });

        function transfer_order_popup(ordernumber) {
        var url = "/cgi-bin/koha/acqui/transferorder.pl?"
            + "ordernumber=" + ordernumber
            window.open(url, 'TransferOrder');
        }
    </script>
[% END %]

[% INCLUDE 'intranet-bottom.inc' %]
